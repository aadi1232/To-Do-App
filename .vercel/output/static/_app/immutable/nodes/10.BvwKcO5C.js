import"../chunks/CWj6FrbW.js";import"../chunks/69_IOA4Y.js";import{as as Nt,at as Rr,p as qt,b as a,m as x,g as e,c as o,s as n,r,a as zt,t as C,$ as Dr,f as Ut,d as ne,au as $r,n as Ar}from"../chunks/PWWI3Ue3.js";import{l as Mr,t as u,e as E,a as c,s as k,h as jr,b as Ft}from"../chunks/BC15lkC2.js";import{i as m}from"../chunks/BsCQza_p.js";import{e as dt,i as ct}from"../chunks/FrGZEVpv.js";import{r as ze,a as Bt,s as nt}from"../chunks/CjOiFDoo.js";import{s as Ue,c as Fr}from"../chunks/DBYvBCBS.js";import{t as Pt,f as Ot}from"../chunks/CtkfvfXh.js";import{b as Ke}from"../chunks/CO0VHtSE.js";import{p as It}from"../chunks/CWmzcjye.js";import{i as Vt}from"../chunks/BEc5jUYy.js";import{s as Nr,a as qr}from"../chunks/6avubi_o.js";import{p as zr}from"../chunks/DZk701PN.js";import{g as it}from"../chunks/C5OadaZi.js";import{o as Yt,a as Ht}from"../chunks/D93VaLay.js";import{b as Br,u as Pr,i as Or,d as Vr,e as Yr}from"../chunks/BcYMahjX.js";import{h as Hr,g as Jr,d as Qr,u as Zr,c as Kr,a as Wr}from"../chunks/CWcjEGFN.js";import{p as lt}from"../chunks/LNgpw9vD.js";import{g as Jt}from"../chunks/CNzxuJyc.js";import{c as Ct,o as Xr,i as eo,j as to}from"../chunks/BIOqlViq.js";function Qt(b,B,q){if(b.multiple)return ao(b,B);for(var J of b.options){var Q=We(J);if(Rr(Q,B)){J.selected=!0;return}}(!q||B!==void 0)&&(b.selectedIndex=-1)}function ro(b,B){Nt(()=>{var q=new MutationObserver(()=>{var J=b.__value;Qt(b,J)});return q.observe(b,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),()=>{q.disconnect()}})}function oo(b,B,q=B){var J=!0;Mr(b,"change",Q=>{var v=Q?"[selected]":":checked",d;if(b.multiple)d=[].map.call(b.querySelectorAll(v),We);else{var G=b.querySelector(v)??b.querySelector("option:not([disabled])");d=G&&We(G)}q(d)}),Nt(()=>{var Q=B();if(Qt(b,Q,J),J&&Q===void 0){var v=b.querySelector(":checked");v!==null&&(Q=We(v),q(Q))}b.__value=Q,J=!1}),ro(b)}function ao(b,B){for(var q of b.options)q.selected=~B.indexOf(We(q))}function We(b){return"__value"in b?b.__value:b.value}var so=u('<button type="button" class="absolute inset-y-0 end-2.5 my-auto flex h-6 w-6 items-center justify-center rounded-full text-gray-500 hover:bg-gray-100" aria-label="Clear search"><svg class="h-3 w-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path></svg></button>'),no=u('<div class="mt-1 text-xs text-gray-500">Using basic search mode (Typesense not available)</div>'),io=u('<div class="mt-2 flex justify-center"><div class="h-4 w-4 animate-spin rounded-full border-2 border-blue-500 border-t-transparent"></div></div>'),lo=u('<p class="text-sm"><!></p>'),co=u('<p class="text-sm"> </p>'),uo=u('<div class="flex items-center space-x-2"><span class="text-xs text-gray-500"> </span> <button class="ml-2 text-red-500 hover:text-red-700" title="Delete" aria-label="Delete todo"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>'),vo=u('<li class="flex px-4 py-3"><div class="flex flex-grow items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <div class="ml-3"><!></div></div> <!></li>'),po=u('<div class="mt-4 rounded-md border border-gray-200 bg-white shadow-sm"><ul class="divide-y divide-gray-100"></ul></div>'),fo=u('<div class="mb-6"><div class="relative"><div class="pointer-events-none absolute inset-y-0 start-0 flex items-center ps-3"><svg class="h-4 w-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"></path></svg></div> <input type="search" class="block w-full rounded-lg border border-gray-300 bg-white p-2.5 ps-10 text-sm text-gray-900 focus:border-blue-500 focus:ring-blue-500" placeholder="Search group todos..." aria-label="Search group todos"> <!> <!></div> <!> <!></div>');function go(b,B){qt(B,!1);let q=lt(B,"groupId",8),J=lt(B,"onToggleTodo",8,i=>{}),Q=lt(B,"onDeleteTodo",8,i=>{}),v=lt(B,"canEdit",8,!0),d=x(""),G=x([]),Ie=x(!1),pe=null,Z=!1,j=x(!1),ye=0,fe=null;Yt(async()=>{try{Z=!0,a(j,!0),await Be(),H(),oe()}catch(i){console.error("Failed to initialize group search:",i),a(j,!0)}}),Ht(()=>{pe&&clearTimeout(pe),ge(),fe&&(clearInterval(fe),fe=null)});function H(){if(typeof window<"u"){if(!Jt(Ct)){console.log("Socket not connected, real-time updates unavailable");return}console.log(`Setting up real-time event listeners for group ${q()}`),window.addEventListener("todo:added",P),window.addEventListener("todo:updated",P),window.addEventListener("todo:deleted",P),window.addEventListener("todo:completed",P)}}function ge(){typeof window<"u"&&(window.removeEventListener("todo:added",P),window.removeEventListener("todo:updated",P),window.removeEventListener("todo:deleted",P),window.removeEventListener("todo:completed",P))}function P(i){var w,F;console.log("Received real-time todo update:",i.type);try{const K=i.detail;if(K&&K.groupId===q()&&(console.log(`Todo ${i.type.split(":")[1]} in this group:`,K),e(d).trim())){const z=((F=(w=K.todo)==null?void 0:w.title)==null?void 0:F.toLowerCase())||"",$=e(d).trim().toLowerCase(),T=Date.now();T-ye>500&&(i.type==="todo:deleted"||i.type==="todo:updated"||i.type==="todo:completed"||z.includes($))&&(console.log("Refreshing search due to relevant todo change"),Ce(),ye=T)}}catch(K){console.error("Error handling todo change event:",K)}}function Ce(){e(d).trim()&&(console.log("Refreshing search due to real-time update"),Ge(!0))}async function Ge(i=!1){if(pe&&clearTimeout(pe),!e(d).trim()){a(G,[]);return}const w=async()=>{a(Ie,!0);try{const F=e(d).trim(),K=encodeURIComponent(F);console.log(`Searching group todos with query: ${F} (encoded: ${K})`);const z=new URL("/api/search/todos/group",window.location.origin);z.searchParams.append("query",F),z.searchParams.append("groupId",q()),console.log(`Making search request to: ${z.toString()}`);try{const $=await fetch(z.toString());console.log(`Search API response status: ${$.status}`);try{const T=await $.json();console.log("Group search results:",T),a(j,T.fallback===!0),T.hits&&Array.isArray(T.hits)?a(G,T.hits.map(_=>({_id:_.document.id,title:_.document.title,completed:_.document.completed,createdBy:_.document.createdBy,highlights:_.highlights?_.highlights.map(Ve=>Ve.snippet):[]}))):(console.warn("Unexpected group search results format:",T),a(G,[]))}catch(T){console.error("Failed to parse search results:",T);const _=await $.text();console.log("Raw API response:",_),a(G,[])}}catch($){console.error("Network error during search:",$),a(G,[])}}catch(F){console.error("Error during group search:",F),a(G,[])}finally{a(Ie,!1),ye=Date.now()}};i?await w():pe=setTimeout(w,150)}function re(){a(d,""),a(G,[])}function oe(){fe&&clearInterval(fe),fe=setInterval(()=>{console.log("Background sync: refreshing search index"),Be(!0),e(d).trim()&&Ce()},1e4),console.log("Started background sync for search index")}async function Be(i=!1){try{i||console.log(`Attempting to sync todos for group: ${q()}`);const w=await fetch(`/api/search/todos/group/sync?groupId=${encodeURIComponent(q())}`,{method:"POST",headers:{"Content-Type":"application/json"}});i||console.log(`Sync API response status: ${w.status}`);try{const F=await w.json();return i||console.log("Sync API response data:",F),a(j,F.fallback===!0),e(j)&&!i?console.log(`Using fallback search: ${F.message||"Typesense not available"}`):i||console.log("Search system initialized with Typesense"),!0}catch(F){return i||(console.warn("Failed to parse search sync response:",F),console.log("Raw response:",await w.text())),!1}}catch(w){return i||(console.warn("Search sync network request failed:",w),console.log("Will use fallback search instead")),!1}}Vt();var Y=fo(),me=o(Y),ie=n(o(me),2);ze(ie);var Se=n(ie,2);{var Pe=i=>{var w=so();E("click",w,re),c(i,w)};m(Se,i=>{e(d)&&i(Pe)})}var xe=n(Se,2);{var le=i=>{var w=no();c(i,w)};m(xe,i=>{e(j)&&i(le)})}r(me);var Re=n(me,2);{var Oe=i=>{var w=io();c(i,w)};m(Re,i=>{e(Ie)&&i(Oe)})}var we=n(Re,2);{var _e=i=>{var w=po(),F=o(w);dt(F,5,()=>e(G),ct,(K,z)=>{var $=vo(),T=o($),_=o(T);ze(_);var Ve=n(_,2),Xe=o(Ve);{var et=W=>{var O=lo(),be=o(O);Hr(be,()=>e(z).highlights[0]),r(O),c(W,O)},ut=W=>{var O=co(),be=o(O,!0);r(O),C(()=>k(be,e(z).title)),c(W,O)};m(Xe,W=>{e(z).highlights&&e(z).highlights.length>0?W(et):W(ut,!1)})}r(Ve),r(T);var He=n(T,2);{var h=W=>{var O=uo(),be=o(O),tt=o(be,!0);r(be);var Je=n(be,2);r(O),C(()=>k(tt,typeof e(z).createdBy=="string"?"Unknown":e(z).createdBy.username)),E("click",Je,()=>Q()(e(z))),c(W,O)};m(He,W=>{v()&&W(h)})}r($),C(()=>{Bt(_,e(z).completed),_.disabled=!v()}),E("change",_,()=>J()(e(z)._id)),c(K,$)}),r(F),r(w),Pt(3,w,()=>Ot,()=>({duration:150})),c(i,w)};m(we,i=>{e(G).length>0&&i(_e)})}r(Y),Ke(ie,()=>e(d),i=>a(d,i)),E("input",ie,()=>Ge(!1)),c(b,Y),zt()}var mo=u("<div> </div>"),bo=u('<div class="flex h-64 items-center justify-center"><div class="animate-pulse text-gray-600">Loading group...</div></div>'),ho=u('<div class="rounded-lg border border-gray-200 bg-white p-6 text-center shadow-sm"><p class="mb-4 text-gray-700"> </p> <button class="rounded bg-black px-4 py-2 text-white hover:bg-gray-800">Return to Groups</button></div>'),yo=u('<img class="h-24 w-24 rounded-full border-2 border-gray-200 object-cover">'),xo=u('<div class="flex h-24 w-24 items-center justify-center rounded-full border-2 border-gray-200 bg-gray-100 text-2xl font-semibold text-gray-700"> </div>'),wo=u('<div class="mt-2"><span> </span></div>'),_o=u("<button>Settings</button>"),Eo=u('<div class="mb-4 rounded-md bg-blue-50 p-3 text-sm text-blue-700">You are a member of this group and have read-only access to todos.</div>'),ko=u('<form class="mb-6"><div class="flex"><input type="text" placeholder="Add a new todo..." class="flex-grow rounded-l border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none"> <button type="submit" class="rounded-r bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50"> </button></div></form>'),To=u('<div class="flex flex-col items-center py-3"><div class="mb-2 h-6 w-6 animate-spin rounded-full border-2 border-gray-300 border-t-blue-500"></div> <p class="text-xs text-gray-500">AI is generating suggestions...</p></div>'),Lo=u("<div> </div>"),Uo=u('<p class="px-3 py-2 text-xs font-medium text-gray-500">AI suggestions:</p> <!>',1),Io=u('<div class="relative mt-1 mb-4"><div class="absolute z-10 w-full rounded-md border border-gray-200 bg-white shadow-lg"><div class="py-1"><!></div></div></div>'),Co=u('<p class="py-8 text-center text-gray-500"><!></p>'),Go=u('<button class="ml-2 text-red-500 hover:text-red-700" title="Delete"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>'),So=u('<li class="flex items-center justify-between rounded border border-gray-200 bg-white p-3 shadow-sm"><div class="flex items-center"><input type="checkbox" class="mr-3 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span> </span></div> <div class="flex items-center space-x-2"><span class="text-xs text-gray-500"> </span> <!></div></li>'),Ro=u('<ul class="space-y-2"></ul>'),Do=u('<div class="todos-section"><h2 class="mb-4 text-xl font-medium">Group To-Dos</h2> <!> <!> <!> <!> <!></div>'),$o=u('<div class="mb-6"><form class="flex items-end space-x-2"><div class="flex-grow"><label for="inviteEmail" class="mb-1 block text-sm font-medium text-gray-700">Invite New Member</label> <input id="inviteEmail" type="email" placeholder="Enter email address" class="w-full rounded border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none"></div> <button type="submit" class="rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50"> </button></form></div>'),Ao=u('<img class="h-full w-full object-cover">'),Mo=u('<div class="flex h-full w-full items-center justify-center bg-blue-500 text-white"> </div>'),jo=u('<span class="absolute right-0 bottom-0 h-3 w-3 rounded-full border border-white bg-green-500" title="Online"></span>'),Fo=u('<span class="ml-2 text-xs font-normal text-green-600">Online</span>'),No=u('<div class="ml-2 flex space-x-2"><button class="rounded border border-gray-300 px-2 py-1 text-xs hover:bg-gray-100" title="Change role">Change Role</button> <button class="rounded border border-red-300 px-2 py-1 text-xs text-red-600 hover:bg-red-50" title="Remove"> </button></div>'),qo=u('<li class="rounded border border-blue-100 bg-blue-50 p-4"><h4 class="mb-2 font-medium"> </h4> <div class="flex items-center space-x-3"><select class="rounded border border-gray-300 px-2 py-1 text-sm"><option>Co-Lead</option><option>Elder</option><option>Member</option></select> <button class="rounded bg-blue-600 px-3 py-1 text-sm text-white hover:bg-blue-700"> </button> <button class="rounded px-2 py-1 text-sm text-gray-600 hover:text-gray-800">Cancel</button></div></li>'),zo=u('<li class="flex items-center justify-between rounded border border-gray-200 bg-white p-4 shadow-sm"><div class="flex items-center"><div class="relative mr-3 h-10 w-10 overflow-hidden rounded-full bg-gray-200"><!> <!></div> <div><p class="flex items-center font-medium"> <!></p> <p class="text-xs text-gray-500"> </p></div></div> <div class="flex items-center space-x-2"><span> </span> <span class="text-xs text-gray-500"> </span> <!></div></li> <!>',1),Bo=u('<div class="members-section"><h2 class="mb-4 text-xl font-medium">Group Members</h2> <!> <ul class="space-y-4"></ul></div>'),Po=u(`<div class="settings-section"><h2 class="mb-6 text-xl font-medium">Group Settings</h2> <div class="mb-8 rounded border border-gray-200 bg-white p-6 shadow-sm"><h3 class="mb-4 text-lg font-medium">Edit Group</h3> <form><div class="mb-4"><label for="groupName" class="mb-1 block text-sm font-medium text-gray-700">Group Name</label> <input id="groupName" type="text" class="w-full rounded border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none" required></div> <div class="mb-4"><label for="imageUrl" class="mb-1 block text-sm font-medium text-gray-700">Group Image URL</label> <input id="imageUrl" type="text" placeholder="https://example.com/image.jpg" class="w-full rounded border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none"> <p class="mt-1 text-xs text-gray-500">Leave blank for auto-generated initials</p></div> <button type="submit" class="rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50"> </button></form></div> <div class="rounded border border-red-200 bg-red-50 p-6"><h3 class="mb-4 text-lg font-medium text-red-700">Danger Zone</h3> <p class="mb-4 text-sm text-gray-600">Deleting the group will permanently remove all group data, including todos and
								member relationships. This action cannot be undone.</p> <button class="rounded bg-red-600 px-4 py-2 text-white hover:bg-red-700 disabled:opacity-50"> </button></div></div>`),Oo=u('<div class="mb-6 rounded-lg border border-gray-200 bg-white p-6 shadow-sm"><div class="flex flex-col items-center gap-6 md:flex-row md:items-start"><div class="relative h-24 w-24"><!></div> <div><h1 class="text-2xl font-bold"> </h1> <p class="mt-1 text-gray-600"> </p> <p class="mt-2 text-sm text-gray-500"> </p> <!></div></div></div> <div class="mb-6 border-b border-gray-200"><nav class="-mb-px flex items-center"><div class="flex flex-grow space-x-8"><button>To-Dos</button> <button>Members</button> <!></div> <button class="flex items-center rounded-md bg-black px-4 py-2 text-sm text-white hover:bg-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="mr-1 h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg> Share</button></nav></div> <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm"><!></div>',1),Vo=u('<div class="min-h-screen bg-white"><!> <div class="container mx-auto max-w-4xl p-6"><div class="mb-6"><button class="flex items-center text-gray-600 hover:text-gray-900"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg> <span class="ml-1">Back to Groups</span></button></div> <!></div></div>');function pa(b,B){qt(B,!1);const[q,J]=qr(),v=Nr(zr,"$page",q).params.id;let d=x(null),G=x([]),Ie=x(!0),pe=x(null),Z=x(null),j=x(null),ye=x(null),fe=x("success"),H=x(""),ge=x(""),P=x("todos"),Ce=x(!1),Ge=x(!1),re=x([]),oe=x(!1),Be=x(!1),Y=x(-1),me=null,ie=x(""),Se=x(""),Pe=x(""),xe=x("member"),le=x(!1),Re=x(!1),Oe=x(!1),we=Date.now(),_e=!1,i=null,w=new Set;const F=Xr.subscribe(t=>{w=t});Yt(async()=>{try{const t=await fetch("/api/auth/me");if(!t.ok){if(t.status===401){it("/auth/login");return}throw new Error("Authentication failed")}a(Z,await t.json());const s=await fetch(`/api/groups/${v}`);if(!s.ok)throw new Error("Failed to fetch group details");const p=await s.json();if(a(d,p.group),e(d)&&e(Z)){const N=e(d).members.find(de=>{var Ee,ke;return typeof de.user=="string"?de.user===((Ee=e(Z))==null?void 0:Ee._id):de.user._id===((ke=e(Z))==null?void 0:ke._id)});N&&a(j,N.role)}await _(),e(d)&&(a(ie,e(d).name),a(Se,e(d).imageUrl||"")),K(),ar(),a(Ie,!1)}catch(t){console.error("Error loading group:",t),a(pe,t instanceof Error?t.message:"Failed to load group"),a(Ie,!1)}}),Ht(()=>{z(),me&&clearTimeout(me),i&&(clearInterval(i),i=null),F()});function K(){if(typeof window<"u"){if(console.log(`Setting up real-time event listeners for group ${v}`),!Jt(Ct)&&e(Z)){console.log("Socket not connected, attempting to initialize..."),eo(e(Z)._id,[v]);const s=Ct.subscribe(p=>{p&&(console.log("Socket connected! Forcing immediate refresh"),_(),s())})}else console.log("Ensuring we are joined to the group socket room"),to(v);window.addEventListener("todo:added",T),window.addEventListener("todo:updated",T),window.addEventListener("todo:deleted",T),window.addEventListener("todo:completed",T),window.addEventListener(`todo:added-group-${v}`,$),window.addEventListener(`todo:updated-group-${v}`,$),window.addEventListener(`todo:deleted-group-${v}`,$),window.addEventListener(`todo:completed-group-${v}`,$),setTimeout(()=>{console.log("Initial page load - forcing refresh of todos"),_()},300)}}function z(){typeof window<"u"&&(window.removeEventListener("todo:added",T),window.removeEventListener("todo:updated",T),window.removeEventListener("todo:deleted",T),window.removeEventListener("todo:completed",T),window.removeEventListener(`todo:added-group-${v}`,$),window.removeEventListener(`todo:updated-group-${v}`,$),window.removeEventListener(`todo:deleted-group-${v}`,$),window.removeEventListener(`todo:completed-group-${v}`,$))}function $(t){console.log(`DIRECT: Received group-specific ${t.type} event:`,t.detail);const s=Date.now();s-we>300?(console.log("Immediately refreshing todos for group-specific event"),_(),we=s):_e||(_e=!0,setTimeout(()=>{console.log("Executing delayed refresh for throttled event"),_(),_e=!1,we=Date.now()},500))}function T(t){console.log("Received todo event in group page:",t.type);try{const s=t.detail;if(s&&s.groupId===v){console.log(`Todo ${t.type.split(":")[1]} in this group, refreshing todos list`);const p=Date.now();p-we>500?(_(),we=p):_e||(_e=!0,setTimeout(()=>{console.log("Executing delayed refresh for throttled event"),_(),_e=!1,we=Date.now()},700))}}catch(s){console.error("Error handling todo event:",s)}}async function _(t=!1){try{t||console.log("Manually fetching todos for group:",v);const s=await Jr(v);t?console.log("Background sync: received",s.length,"todos"):console.log("Received todos:",s.length),!t&&e(G).length===0?(console.log("No todos loaded yet, updating the list"),a(G,s)):e(G).length!==s.length||JSON.stringify(e(G).map(p=>p._id).sort())!==JSON.stringify(s.map(p=>p._id).sort())?(console.log("Todos have changed, updating the list"),a(G,s)):t||(console.log("Forcing update for manual refresh"),a(G,[...s]))}catch(s){console.error("Error fetching todos:",s),t||h("Failed to load todos","error")}}async function Ve(){var t,s;if(!e(H).trim()){h("Todo title cannot be empty","error");return}a(Ce,!0);try{if(await Kr(v,{title:e(H).trim()}),typeof window<"u"){const p=new CustomEvent("todo:added",{detail:{groupId:v,groupName:((t=e(d))==null?void 0:t.name)||"Group",userName:((s=e(Z))==null?void 0:s.username)||"User",title:e(H).trim()},bubbles:!0,cancelable:!0});window.dispatchEvent(p)}a(H,""),await _(),h("Todo added successfully")}catch(p){console.error("Error adding todo:",p),h(p instanceof Error?p.message:"Failed to add todo","error")}finally{a(Ce,!1)}}async function Xe(t){var s,p;try{if(await Zr(t._id,{completed:!t.completed}),typeof window<"u"){const N=new CustomEvent("todo:updated",{detail:{groupId:v,groupName:((s=e(d))==null?void 0:s.name)||"Group",userName:((p=e(Z))==null?void 0:p.username)||"User",title:t.title,completed:!t.completed},bubbles:!0,cancelable:!0});window.dispatchEvent(N)}await _()}catch(N){console.error("Error updating todo:",N),h(N instanceof Error?N.message:"Failed to update todo","error")}}async function et(t){var s,p;try{if(await Qr(t._id),typeof window<"u"){const N=new CustomEvent("todo:deleted",{detail:{groupId:v,groupName:((s=e(d))==null?void 0:s.name)||"Group",userName:((p=e(Z))==null?void 0:p.username)||"User",title:t.title},bubbles:!0,cancelable:!0});window.dispatchEvent(N)}await _(),h("Todo deleted successfully")}catch(N){console.error("Error deleting todo:",N),h(N instanceof Error?N.message:"Failed to delete todo","error")}}async function ut(){if(!e(ge).trim()){h("Email cannot be empty","error");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e(ge))){h("Please enter a valid email address","error");return}a(Ge,!0);try{const s=await Or(v,e(ge));a(ge,""),s&&a(d,s),h("Invitation sent successfully")}catch(s){console.error("Error inviting user:",s),h(s instanceof Error?s.message:"Failed to invite user","error")}finally{a(Ge,!1)}}function He(t){a(P,t)}function h(t,s="success"){a(ye,t),a(fe,s),setTimeout(()=>{a(ye,null)},3e3)}function W(){const s=`${window.location.origin}/shared/group/${v}`;if(navigator.clipboard)navigator.clipboard.writeText(s).then(()=>{h("View-only link copied to clipboard! Anyone with this link can view this group without logging in.")}).catch(p=>{console.error("Could not copy text: ",p),h("Failed to copy link","error")});else{const p=document.createElement("textarea");p.value=s,document.body.appendChild(p),p.select();try{document.execCommand("copy")?h("View-only link copied to clipboard! Anyone with this link can view this group without logging in."):h("Failed to copy link","error")}catch(N){console.error("Could not copy text: ",N),h("Failed to copy link","error")}document.body.removeChild(p)}}function O(t){return typeof t.user=="string"?"Unknown User":t.user.username}function be(t){return typeof t.user=="string"?"":t.user.email}function tt(t){switch(t){case"admin":return"bg-red-100 text-red-800";case"co-lead":return"bg-purple-100 text-purple-800";case"elder":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}}function Je(){return e(j)==="admin"||e(j)==="co-lead"}function rt(){return e(j)!=="member"}async function Zt(){if(!e(ie).trim()){h("Group name cannot be empty","error");return}a(Oe,!0);try{const t=await Vr(v,{name:e(ie),imageUrl:e(Se)});t&&(a(d,t),h("Group details updated successfully"))}catch(t){console.error("Error updating group:",t),h(t instanceof Error?t.message:"Failed to update group","error")}finally{a(Oe,!1)}}async function Kt(){a(Re,!0);try{(await Yr(v)).success&&(h("Group deleted successfully"),setTimeout(()=>{it("/groups")},1500))}catch(t){console.error("Error deleting group:",t),h(t instanceof Error?t.message:"Failed to delete group","error")}finally{a(Re,!1)}}async function Wt(t){if(!t||!e(xe)){h("Member and role are required","error");return}a(le,!0);try{const s=await Pr(v,t,e(xe));s&&(a(d,s),h(`Member role updated to ${e(xe)}`),setTimeout(()=>{a(Pe,"")},100))}catch(s){console.error("Error updating member role:",s),h(s instanceof Error?s.message:"Failed to update role","error")}finally{a(le,!1)}}async function Xt(t){a(le,!0);try{const s=await Br(v,t);s&&(a(d,s),h("Member removed successfully"))}catch(s){console.error("Error removing member:",s),h(s instanceof Error?s.message:"Failed to remove member","error")}finally{a(le,!1)}}async function er(){if(e(H).trim().length<2){a(re,[]),a(oe,!1);return}a(Be,!0);try{a(re,await Wr(e(H))),a(oe,e(re).length>0),a(Y,-1)}catch(t){console.error("Error fetching suggestions:",t),a(re,[])}finally{a(Be,!1)}}function tr(){me&&clearTimeout(me),me=window.setTimeout(()=>{er()},500)}function rr(t){if(e(oe))switch(t.key){case"ArrowDown":t.preventDefault(),a(Y,Math.min(e(Y)+1,e(re).length-1));break;case"ArrowUp":t.preventDefault(),a(Y,Math.max(e(Y)-1,-1));break;case"Enter":e(Y)>=0&&e(Y)<e(re).length&&(t.preventDefault(),a(H,e(re)[e(Y)]),a(oe,!1));break;case"Escape":t.preventDefault(),a(oe,!1);break}}function or(t){a(H,t),a(oe,!1)}function ar(){i&&clearInterval(i),i=window.setInterval(()=>{console.log("Background sync: checking for todo updates"),_(!0)},5e3),console.log("Started background sync for todos")}function Gt(t){return t?w.has(t):!1}Vt();var vt=Vo();jr(t=>{C(()=>Dr.title=`${(e(d)?e(d).name:"Group")??""} | To-Do App`)});var St=o(vt);{var sr=t=>{var s=mo(),p=o(s,!0);r(s),C(()=>{Ue(s,1,`fixed top-4 right-4 z-50 rounded-lg p-4 shadow-lg ${e(fe)==="success"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`),k(p,e(ye))}),Pt(3,s,()=>Ot),c(t,s)};m(St,t=>{e(ye)&&t(sr)})}var Rt=n(St,2),pt=o(Rt),nr=o(pt);r(pt);var ir=n(pt,2);{var lr=t=>{var s=bo();c(t,s)},dr=(t,s)=>{{var p=de=>{var Ee=ho(),ke=o(Ee),Qe=o(ke,!0);r(ke);var ot=n(ke,2);r(Ee),C(()=>k(Qe,e(pe))),E("click",ot,()=>it("/groups")),c(de,Ee)},N=(de,Ee)=>{{var ke=Qe=>{var ot=Oo(),ft=Ut(ot),Dt=o(ft),gt=o(Dt),cr=o(gt);{var ur=I=>{var R=yo();C(()=>{nt(R,"src",e(d).imageUrl),nt(R,"alt",e(d).name)}),c(I,R)},vr=I=>{var R=xo(),ce=o(R,!0);r(R),C(De=>k(ce,De),[()=>e(d).name.charAt(0).toUpperCase()],ne),c(I,R)};m(cr,I=>{e(d).imageUrl&&e(d).imageUrl.length>2?I(ur):I(vr,!1)})}r(gt);var $t=n(gt,2),mt=o($t),pr=o(mt,!0);r(mt);var bt=n(mt,2),fr=o(bt);r(bt);var ht=n(bt,2),gr=o(ht);r(ht);var mr=n(ht,2);{var br=I=>{var R=wo(),ce=o(R),De=o(ce);r(ce),r(R),C(ae=>{Ue(ce,1,`rounded-full px-3 py-1 text-xs font-medium ${ae??""}`),k(De,`Your role: ${e(j)??""}`)},[()=>tt(e(j))],ne),c(I,R)};m(mr,I=>{e(j)&&I(br)})}r($t),r(Dt),r(ft);var yt=n(ft,2),At=o(yt),xt=o(At),wt=o(xt),_t=n(wt,2),hr=n(_t,2);{var yr=I=>{var R=_o();C(()=>Ue(R,1,`px-1 py-4 text-sm font-medium ${e(P)==="settings"?"border-b-2 border-black text-black":"text-gray-500 hover:text-gray-700"}`)),E("click",R,()=>He("settings")),c(I,R)};m(hr,I=>{Je()&&I(yr)})}r(xt);var xr=n(xt,2);r(At),r(yt);var Mt=n(yt,2),wr=o(Mt);{var _r=I=>{var R=Do(),ce=n(o(R),2);{var De=f=>{var g=Eo();c(f,g)};m(ce,f=>{e(j)==="member"&&f(De)})}var ae=n(ce,2);const $e=ne(rt);go(ae,{groupId:v,onToggleTodo:f=>{const g=e(G).find(A=>A._id===f);g&&Xe(g)},onDeleteTodo:f=>et(f),get canEdit(){return e($e)}});var Ae=n(ae,2);{var Me=f=>{var g=ko(),A=o(g),y=o(A);ze(y);var V=n(y,2),D=o(V,!0);r(V),r(A),r(g),C(M=>{V.disabled=M,k(D,e(Ce)?"Adding...":"Add")},[()=>e(Ce)||!e(H).trim()],ne),Ke(y,()=>e(H),M=>a(H,M)),E("input",y,tr),E("keydown",y,rr),E("blur",y,()=>{setTimeout(()=>{a(oe,!1)},200)}),E("focus",y,()=>{e(re).length>0&&a(oe,!0)}),E("submit",g,It(Ve)),c(f,g)};m(Ae,f=>{rt()&&f(Me)})}var he=n(Ae,2);{var se=f=>{var g=Io(),A=o(g),y=o(A),V=o(y);{var D=S=>{var ue=To();c(S,ue)},M=S=>{var ue=Uo(),je=n(Ut(ue),2);dt(je,1,()=>e(re),ct,(Fe,Ye,Ne)=>{var ve=Lo(),Te=o(ve,!0);r(ve),C(()=>{Ue(ve,1,`cursor-pointer px-3 py-2 hover:bg-gray-100 ${Ne===e(Y)?"bg-gray-100":""}`),k(Te,e(Ye))}),E("mousedown",ve,()=>or(e(Ye))),E("mouseover",ve,()=>a(Y,Ne)),c(Fe,ve)}),c(S,ue)};m(V,S=>{e(Be)?S(D):S(M,!1)})}r(y),r(A),r(g),c(f,g)};m(he,f=>{e(oe)&&f(se)})}var l=n(he,2);{var X=f=>{var g=Co(),A=o(g);{var y=D=>{var M=Ft("No todos yet. You are a member and can only read todos in this group.");c(D,M)},V=D=>{var M=Ft();C(S=>k(M,`No todos yet. ${S??""}`),[()=>rt()?"Add one to get started!":""],ne),c(D,M)};m(A,D=>{e(j)==="member"?D(y):D(V,!1)})}r(g),c(f,g)},ee=f=>{var g=Ro();dt(g,5,()=>e(G),ct,(A,y)=>{var V=So(),D=o(V),M=o(D);ze(M);var S=n(M,2),ue=o(S,!0);r(S),r(D);var je=n(D,2),Fe=o(je),Ye=o(Fe,!0);r(Fe);var Ne=n(Fe,2);{var ve=Te=>{var qe=Go();E("click",qe,()=>et(e(y))),c(Te,qe)};m(Ne,Te=>{rt()&&Te(ve)})}r(je),r(V),C(()=>{Bt(M,e(y).completed),M.disabled=e(j)==="member",Ue(S,1,Fr(e(y).completed?"text-gray-500 line-through":"")),k(ue,e(y).title),k(Ye,typeof e(y).createdBy=="string"?"Unknown":e(y).createdBy.username)}),E("change",M,()=>Xe(e(y))),c(A,V)}),r(g),c(f,g)};m(l,f=>{e(G).length===0?f(X):f(ee,!1)})}r(R),c(I,R)},Er=(I,R)=>{{var ce=ae=>{var $e=Bo(),Ae=n(o($e),2);{var Me=se=>{var l=$o(),X=o(l),ee=o(X),f=n(o(ee),2);ze(f),r(ee);var g=n(ee,2),A=o(g,!0);r(g),r(X),r(l),C(y=>{g.disabled=y,k(A,e(Ge)?"Sending...":"Invite")},[()=>e(Ge)||!e(ge).trim()],ne),Ke(f,()=>e(ge),y=>a(ge,y)),E("submit",X,It(ut)),c(se,l)};m(Ae,se=>{Je()&&se(Me)})}var he=n(Ae,2);dt(he,5,()=>e(d).members,ct,(se,l)=>{var X=zo(),ee=Ut(X),f=o(ee),g=o(f),A=o(g);{var y=L=>{var U=Ao();C(te=>{nt(U,"src",e(l).user.profileImage),nt(U,"alt",te)},[()=>O(e(l))],ne),c(L,U)},V=L=>{var U=Mo(),te=o(U,!0);r(U),C(Le=>k(te,Le),[()=>O(e(l)).charAt(0).toUpperCase()],ne),c(L,U)};m(A,L=>{typeof e(l).user!="string"&&e(l).user.profileImage?L(y):L(V,!1)})}var D=n(A,2);{var M=L=>{var U=jo();c(L,U)};m(D,L=>{Gt(typeof e(l).user=="string"?e(l).user:e(l).user._id)&&L(M)})}r(g);var S=n(g,2),ue=o(S),je=o(ue),Fe=n(je);{var Ye=L=>{var U=Fo();c(L,U)};m(Fe,L=>{Gt(typeof e(l).user=="string"?e(l).user:e(l).user._id)&&L(Ye)})}r(ue);var Ne=n(ue,2),ve=o(Ne,!0);r(Ne),r(S),r(f);var Te=n(f,2),qe=o(Te),kr=o(qe,!0);r(qe);var Et=n(qe,2),Tr=o(Et,!0);r(Et);var Lr=n(Et,2);{var Ur=L=>{var U=No(),te=o(U),Le=n(te,2),at=o(Le,!0);r(Le),r(U),C(()=>{Le.disabled=e(le),k(at,e(le)?"...":"Remove")}),E("click",te,()=>a(Pe,typeof e(l).user=="string"?e(l).user:e(l).user._id)),E("click",Le,()=>Xt(typeof e(l).user=="string"?e(l).user:e(l).user._id)),c(L,U)};m(Lr,L=>{var U;(e(j)==="admin"||e(j)==="co-lead"&&e(l).role!=="admin"&&e(l).role!=="co-lead")&&typeof e(l).user!="string"&&e(l).user._id!==((U=e(Z))==null?void 0:U._id)&&e(l).invitationStatus==="accepted"&&L(Ur)})}r(Te),r(ee);var Ir=n(ee,2);{var Cr=L=>{var U=qo(),te=o(U),Le=o(te);r(te);var at=n(te,2),st=o(at);C(()=>{e(xe),$r(()=>{})});var kt=o(st);kt.value=kt.__value="co-lead";var Tt=n(kt);Tt.value=Tt.__value="elder";var jt=n(Tt);jt.value=jt.__value="member",r(st);var Ze=n(st,2),Gr=o(Ze,!0);r(Ze);var Sr=n(Ze,2);r(at),r(U),C(Lt=>{k(Le,`Change role for ${Lt??""}`),Ze.disabled=e(le),k(Gr,e(le)?"Updating...":"Update Role")},[()=>O(e(l))],ne),oo(st,()=>e(xe),Lt=>a(xe,Lt)),E("click",Ze,()=>Wt(typeof e(l).user=="string"?e(l).user:e(l).user._id)),E("click",Sr,()=>a(Pe,"")),c(L,U)};m(Ir,L=>{e(Pe)===(typeof e(l).user=="string"?e(l).user:e(l).user._id)&&L(Cr)})}C((L,U,te)=>{k(je,`${L??""} `),k(ve,U),Ue(qe,1,`rounded-full px-3 py-1 text-xs font-medium ${te??""}`),k(kr,e(l).role),k(Tr,e(l).invitationStatus==="pending"?"(Pending)":"")},[()=>O(e(l)),()=>be(e(l)),()=>tt(e(l).role)],ne),c(se,X)}),r(he),r($e),c(ae,$e)},De=(ae,$e)=>{{var Ae=Me=>{var he=Po(),se=n(o(he),2),l=n(o(se),2),X=o(l),ee=n(o(X),2);ze(ee),r(X);var f=n(X,2),g=n(o(f),2);ze(g),Ar(2),r(f);var A=n(f,2),y=o(A,!0);r(A),r(l),r(se);var V=n(se,2),D=n(o(V),4),M=o(D,!0);r(D),r(V),r(he),C(()=>{A.disabled=e(Oe),k(y,e(Oe)?"Updating...":"Update Group"),D.disabled=e(Re),k(M,e(Re)?"Deleting...":"Delete Group")}),Ke(ee,()=>e(ie),S=>a(ie,S)),Ke(g,()=>e(Se),S=>a(Se,S)),E("submit",l,It(Zt)),E("click",D,()=>{var S;confirm(`Are you sure you want to delete "${(S=e(d))==null?void 0:S.name}"? This action cannot be undone.`)&&Kt()}),c(Me,he)};m(ae,Me=>{e(P)==="settings"&&Je()&&Me(Ae)},$e)}};m(I,ae=>{e(P)==="members"?ae(ce):ae(De,!1)},R)}};m(wr,I=>{e(P)==="todos"?I(_r):I(Er,!1)})}r(Mt),C(I=>{k(pr,e(d).name),k(fr,`${e(d).members.length??""} member${e(d).members.length!==1?"s":""}`),k(gr,`Created: ${I??""}`),Ue(wt,1,`px-1 py-4 text-sm font-medium ${e(P)==="todos"?"border-b-2 border-black text-black":"text-gray-500 hover:text-gray-700"}`),Ue(_t,1,`px-1 py-4 text-sm font-medium ${e(P)==="members"?"border-b-2 border-black text-black":"text-gray-500 hover:text-gray-700"}`)},[()=>e(d).createdAt?new Date(e(d).createdAt).toLocaleDateString():"Unknown date"],ne),E("click",wt,()=>He("todos")),E("click",_t,()=>He("members")),E("click",xr,W),c(Qe,ot)};m(de,Qe=>{e(d)&&Qe(ke)},Ee)}};m(t,de=>{e(pe)?de(p):de(N,!1)},s)}};m(ir,t=>{e(Ie)?t(lr):t(dr,!1)})}r(Rt),r(vt),E("click",nr,()=>it("/groups")),c(b,vt),zt(),J()}export{pa as component};
