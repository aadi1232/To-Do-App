import{l as S}from"./BLRFddlS.js";import{w as a,g as h}from"./CNzxuJyc.js";const p=a(new Set);function $(e){Array.isArray(e)&&p.set(new Set(e))}function m(e){p.update(o=>(o.add(e),o))}function y(e){p.update(o=>(o.delete(e),o))}var u={};const g=a([]),d=a(!1),E=a(0);let n=null;function _(e,o=[]){if(!e){console.warn("Cannot initialize socket without a user ID");return}n&&n.connected&&n.disconnect(),console.log("Initializing socket connection for user:",e);const t=typeof process<"u"&&u&&u.SOCKET_SERVER_URL?u.SOCKET_SERVER_URL:window.location.origin;console.log("Using Socket.IO server URL:",t),n=S(t,{withCredentials:!0,autoConnect:!0,reconnectionAttempts:3,reconnectionDelay:1e3,timeout:5e3,path:"/api/socket.io/",auth:{userId:e}}),n.on("connect",()=>{console.log("Socket connected successfully"),d.set(!0),o.length>0&&n&&(console.log("Joining group rooms:",o),n.emit("join:groups",{groupIds:o})),m(e)}),n.on("disconnect",()=>{console.log("Socket disconnected"),d.set(!1)}),n.on("connect_error",i=>{console.error("Socket connection error:",i.message),console.error("Socket connection error details:",{message:i.message,data:JSON.stringify(i,Object.getOwnPropertyNames(i)),stack:i.stack}),d.set(!1),n&&console.warn("Socket connection failed, will retry a few times")}),k(),b()}function k(){n&&(n.on("notification:test",e=>{console.log("Received test notification:",e)}),n.on("group:invited",e=>{console.log("Received group invitation notification:",e),c({id:`inv_${Date.now()}`,type:"group:invited",title:"Group Invitation",message:e.message,data:e,timestamp:e.timestamp||new Date().toISOString(),read:!1}),r()}),n.on("group:role_changed",e=>{console.log("Received role change notification:",e),c({id:`role_${Date.now()}`,type:"group:role_changed",title:"Role Changed",message:e.message,data:e,timestamp:e.timestamp||new Date().toISOString(),read:!1}),r()}),n.on("group:removed",e=>{console.log("Received group removal notification:",e),c({id:`rem_${Date.now()}`,type:"group:removed",title:"Removed from Group",message:e.message,data:e,timestamp:e.timestamp||new Date().toISOString(),read:!1}),r()}),n.on("group:joined",e=>{c({id:`join_${Date.now()}`,type:"group:joined",title:"Group Update",message:e.message,data:e,timestamp:e.timestamp||new Date().toISOString(),read:!1}),r()}),["todo:added","todo:updated","todo:deleted","todo:completed"].forEach(e=>{n&&n.on(e,o=>{if(console.log(`Received ${e} notification:`,o),typeof window<"u"){console.log(`Dispatching ${e} event to window with data:`,o);try{const l=`${e}-group-${o.groupId}`;console.log(`Also dispatching group-specific event: ${l}`);const w=new CustomEvent(e,{detail:o,bubbles:!0,cancelable:!0}),v=new CustomEvent(l,{detail:o,bubbles:!0,cancelable:!0});window.dispatchEvent(w),window.dispatchEvent(v),setTimeout(()=>{window.dispatchEvent(new Event("resize"))},100)}catch(l){console.error(`Error dispatching ${e} event:`,l)}}let t="";const i=o.userName||"Someone",s=o.groupName||"a group";switch(e){case"todo:added":t=`${i} added a new todo in ${s}: "${o.title||"New todo"}"`;break;case"todo:updated":t=`${i} updated a todo in ${s}: "${o.title||"A todo"}"`;break;case"todo:deleted":t=`${i} deleted a todo in ${s}: "${o.title||"A todo"}"`;break;case"todo:completed":t=`${i} ${o.completed?"completed":"uncompleted"} a todo in ${s}: "${o.title||"A todo"}"`;break;default:t=`Todo update in ${s}`}c({id:`todo_${Date.now()}_${Math.random().toString(36).substring(2,8)}`,type:e,title:"Todo Update",message:t,data:o,timestamp:o.timestamp||new Date().toISOString(),read:!1}),r()})}))}function c(e){g.update(o=>[e,...o].slice(0,50)),f()}function U(e){g.update(o=>o.map(t=>t.id===e?{...t,read:!0}:t)),f()}function f(){const o=h(g).filter(t=>!t.read).length;E.set(o)}function r(){try{console.log("Attempting to play notification sound");const e=new Audio("/notification.mp3");e.volume=.6,e.load(),e.addEventListener("play",()=>{console.log("Notification sound started playing")}),e.addEventListener("ended",()=>{console.log("Notification sound finished playing")}),e.addEventListener("error",t=>{console.error("Audio error:",t)});const o=e.play();o!==void 0&&o.then(()=>{console.log("Successfully playing notification sound")}).catch(t=>{console.warn("Could not play notification sound:",t.message),document.addEventListener("click",function i(){e.play().catch(s=>console.error("Even with click, could not play sound:",s)),document.removeEventListener("click",i)},{once:!0})})}catch(e){console.warn("Error creating audio element:",e)}}function N(e){!n||!n.connected||n.emit("join:groups",{groupIds:[e]})}function A(){n&&(n.disconnect(),n=null),d.set(!1)}function b(){n&&(n.on("online:users",e=>{console.log("Received online users update:",e),e&&Array.isArray(e.userIds)&&$(e.userIds)}),n.on("user:connected",e=>{console.log("User connected:",e),e&&e.userId&&m(e.userId)}),n.on("user:disconnected",e=>{console.log("User disconnected:",e),e&&e.userId&&y(e.userId)}))}export{c as a,A as b,d as c,_ as i,N as j,U as m,g as n,p as o,r as p};
