#!/usr/bin/env node

/**
 * Render deployment helper script
 *
 * This script helps prepare and execute the deployment of the Todo app to Render.
 * It ensures all environment variables are properly set up.
 */

import { execSync } from 'child_process';
import { existsSync, readFileSync } from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import readline from 'readline';
import dotenv from 'dotenv';

// Setup paths
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const envPath = path.join(__dirname, '.env');

// Load environment variables
dotenv.config({ path: envPath });

// Create readline interface
const rl = readline.createInterface({
	input: process.stdin,
	output: process.stdout
});

// Ask for confirmation
function askQuestion(question) {
	return new Promise((resolve) => {
		rl.question(question, (answer) => {
			resolve(answer);
		});
	});
}

// Main function
async function deploy() {
	console.log('🚀 Preparing to deploy to Render...');

	// Check if .env file exists
	if (!existsSync(envPath)) {
		console.error(
			'❌ No .env file found! Please create one first with your MongoDB connection and other settings.'
		);
		process.exit(1);
	}

	// Check if key environment variables are set
	if (!process.env.MONGO_URI) {
		console.error('❌ MONGO_URI is not set in your .env file. Please set it before deploying.');
		process.exit(1);
	}

	if (!process.env.JWT_SECRET) {
		console.warn(
			'⚠️ JWT_SECRET is not set in your .env file. A random one will be generated by Render.'
		);
	}

	console.log('✅ Environment variables validated');

	// Build the app locally to ensure it works
	console.log('🔨 Building the app locally...');
	try {
		execSync('npm run build', { stdio: 'inherit' });
	} catch (error) {
		console.error('❌ Build failed! Fix the errors before deploying.');
		process.exit(1);
	}

	console.log('✅ Build successful!');

	// Ask for confirmation
	const answer = await askQuestion('Are you ready to deploy to Render? (y/n): ');
	if (answer.toLowerCase() !== 'y') {
		console.log('Deployment canceled.');
		rl.close();
		return;
	}

	// Check if a render.yaml file exists
	if (!existsSync(path.join(__dirname, 'render.yaml'))) {
		console.error(
			'❌ No render.yaml file found! This is required for Render Blueprint deployments.'
		);
		process.exit(1);
	}

	console.log('\n📝 To deploy to Render:');
	console.log('1. Push your changes to your Git repository');
	console.log('2. Go to render.com and create a new Blueprint');
	console.log('3. Connect your repository');
	console.log('4. Render will detect the render.yaml file and configure your services');
	console.log('5. Set up your environment variables in the Render dashboard');
	console.log('\nOr manually set up each service as described in DEPLOYMENT.md\n');

	console.log(
		'\n📝 IMPORTANT: Make sure you set up all your environment variables in the Render dashboard:'
	);
	console.log('- MONGO_URI: Your MongoDB connection string');
	console.log('- JWT_SECRET: A secure secret key for JWT tokens');
	console.log(
		"- SOCKET_SERVER_URL: Your Socket.IO server's URL (e.g., https://socket-io-server.onrender.com)"
	);
	console.log('- Add any other environment variables your app needs\n');

	rl.close();
}

// Execute the deploy function
deploy().catch((error) => {
	console.error('Deployment error:', error);
	process.exit(1);
});
